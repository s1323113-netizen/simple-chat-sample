<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Candy Rush üç¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.8.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <style>
      body {
        margin: 0;
        background: radial-gradient(circle at top, #ffe6f7, #ff9dcf, #ff6aa8);
        color: #fff;
        font-family: "Poppins", "Comic Sans MS", sans-serif;
        text-align: center;
        overflow: hidden;
      }

      h1 {
        margin-top: 10px;
        font-size: 42px;
        letter-spacing: 1px;
        color: #fff;
        text-shadow: 2px 2px 8px rgba(255, 0, 100, 0.5);
      }

      p {
        font-size: 18px;
        color: #fff;
        text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
      }

      button {
        margin: 10px;
        padding: 10px 20px;
        font-size: 18px;
        background-color: #ff66b3;
        color: white;
        border: none;
        border-radius: 30px;
        box-shadow: 0 4px 8px rgba(255, 0, 150, 0.4);
        transition: all 0.2s ease;
      }

      button:hover {
        background-color: #ff3385;
        transform: scale(1.05);
      }

      canvas {
        border-radius: 16px;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        margin-top: 10px;
      }
    </style>
  </head>

  <body>
    <h1>üç¨ Candy Rush üç≠</h1>
    <p>„Çπ„Éû„Éõ„ÇíÂÇæ„Åë„Å¶„Ç≠„É£„É≥„Éá„Ç£„ÇíÈõÜ„ÇÅ„Çà„ÅÜÔºÅ</p>
    <div>„ÅÇ„Å™„Åü„ÅÆID: <span id="myid"></span></div>
    <button id="connect">„É´„Éº„É†„Å´ÂÖ•„Çã</button>
    <div>‚Äª„Çπ„Éû„Éõ„Åß„Ç¢„ÇØ„Çª„Çπ„Åó„ÄÅ„Çª„É≥„Çµ„ÉºË®±ÂèØ„Çí„Ç™„É≥„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</div>

    <script>
      let socket = io.connect();

      let myid = sessionStorage.getItem("clientId");
      if (!myid) {
        myid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem("clientId", myid);
      }
      document.getElementById("myid").textContent = myid;

      let g = 0;
      let b = 0;

      document.getElementById("connect").addEventListener("click", function () {
        socket.emit("join", "game");
        document.getElementById("connect").remove();
      });

      socket.on("sensor", function (data) {
        g = parseFloat(data.g);
        b = parseFloat(data.b);
      });

      let player, foods, ghosts;
      let score = 0;
      let gameOver = false;
      let gameClear = false;
      let timeLeft = 30;

      let manImg, ameImg, obakeImg;

      function preload() {
        manImg = loadImage("man.png");
        ameImg = loadImage("ame.png");
        obakeImg = loadImage("obake.png");
      }

      function setup() {
        createCanvas(800, 600);
        resetGame();
      }

      function resetGame() {
        player = { x: width / 2, y: height / 2, size: 50 };
        foods = [];
        ghosts = [];
        score = 0;
        gameOver = false;
        gameClear = false;
        timeLeft = 30;

        for (let i = 0; i < 12; i++) {
          foods.push({
            x: random(80, width - 80),
            y: random(80, height - 80),
            eaten: false,
          });
        }

        for (let i = 0; i < 4; i++) {
          ghosts.push({
            x: random(80, width - 80),
            y: random(80, height - 80),
            dx: random(-2, 2),
            dy: random(-2, 2),
          });
        }

        setInterval(() => {
          if (!gameOver && !gameClear && timeLeft > 0) {
            timeLeft--;
            if (timeLeft <= 0 && !gameOver) {
              gameClear = true;
            }
          }
        }, 1000);
      }

      function draw() {
        background(255, 180, 220);

        if (gameOver) {
          showEndMessage("üëª GAME OVER üëª");
          return;
        }

        if (gameClear) {
          showEndMessage("üç≠ GAME CLEAR!! üç≠");
          return;
        }

        // „Éó„É¨„Ç§„É§„ÉºÁßªÂãïÔºàÈÄüÂ∫¶„Ç¢„ÉÉ„ÉóÔºâ
        player.x += g * 0.06;
        player.y += b * 0.06;

        player.x = constrain(player.x, 50, width - 50);
        player.y = constrain(player.y, 50, height - 50);

        // „Éï„Ç£„Éº„É´„ÉâÊû†
        noFill();
        stroke(255, 100);
        strokeWeight(4);
        rect(40, 40, width - 80, height - 80, 20);

        // È£¥ÊèèÁîª
        for (let f of foods) {
          if (!f.eaten) {
            image(ameImg, f.x, f.y, 30, 30);
            if (dist(player.x, player.y, f.x, f.y) < 30) {
              f.eaten = true;
              score += 10;
            }
          }
        }

        // „ÅäÂåñ„ÅëÂãï‰Ωú
        for (let ghs of ghosts) {
          ghs.x += ghs.dx;
          ghs.y += ghs.dy;

          if (ghs.x < 40 || ghs.x > width - 80) ghs.dx *= -1;
          if (ghs.y < 40 || ghs.y > height - 80) ghs.dy *= -1;

          image(obakeImg, ghs.x, ghs.y, 50, 50);

          if (dist(player.x, player.y, ghs.x, ghs.y) < 40) {
            gameOver = true;
          }
        }

        // „Éó„É¨„Ç§„É§„ÉºÊèèÁîª
        image(manImg, player.x - 25, player.y - 25, 50, 50);

        // „Çπ„Ç≥„Ç¢„ÉªÊôÇÈñì
        noStroke();
        fill(255);
        textSize(20);
        textAlign(LEFT);
        text(`üç¨ „Çπ„Ç≥„Ç¢: ${score}`, 20, 30);
        textAlign(RIGHT);
        text(`‚è±Ô∏è ÊÆã„ÇäÊôÇÈñì: ${timeLeft}s`, width - 20, 30);
      }

      function showEndMessage(msg) {
        textAlign(CENTER);
        textSize(40);
        fill(255);
        text(msg, width / 2, height / 2 - 20);
        textSize(24);
        text(`„Çπ„Ç≥„Ç¢: ${score}`, width / 2, height / 2 + 20);
        text("ÂÜçË™≠„ÅøËæº„Åø„Åß„É™„Çπ„Çø„Éº„ÉàÔºÅ", width / 2, height / 2 + 60);
      }
    </script>
  </body>
</html>
